# ATX-MainframeDependencyManager-MCP

## After you create a package from BuilderHub

This package requires Python version >= 3.10. You should create a version set from `live` version set, and configure
the version set's default interpreter to be `CPython310 or later`, and also build CPython39 with the `no` branch.

```bash
# Create a version set from live
brazil versionset create -vs ATX-MainframeDependencyManager-MCP/development \
--from live \
--platforms AL2_x86_64,AL2023_x86_64,AL2_aarch64,AL2023_aarch64 \
--bindleid <your-software-application-bindle> \
--mailinglist <your-mailing-list>@amazon.com
	 
# Configure the version set with Python310 and remove Python39
brazil packagebuilder build -vs ATX-MainframeDependencyManager-MCP/development \
-p CPython3 --branch CPython310-until-end-of-life \
-p CPython39 --branch no \
-p ATX-MainframeDependencyManager-MCP --branch mainline \
--autoMergeEnabled
```

The command outputs a build link. Your bindle must configure "Consume Brazil Package" permission for the version
set group `ATX-MainframeDependencyManager-MCP` to consume `ATX-MainframeDependencyManager-MCP` package.

Once the build is completed, you can create a workspace with the version set.

```bash
brazil workspace create --name ATX-MainframeDependencyManager-MCP \
-vs ATX-MainframeDependencyManager-MCP/development \
-p ATX-MainframeDependencyManager-MCP
```


#### Building on Mac OS

You should run enable overlay platform support on Mac. 
Run `brazil setup platform-support`.

When running on Mac OS with overlay platform support enabled, some dependencies, e.g. the runtime, will be pulled from `BrazilPlatformOverlay/macos`.
However, pydantic_core library is currently not available in the platform support. You'll see an error like:

```
ModuleNotFoundError: No module named 'pydantic_core._pydantic_core'
```

The current workaround is to manually build pydantic from source
code. The following script is an example for running on Mac x64, inspired by [this sage](https://sage.amazon.dev/posts/1897201?t=7#1956591).

The compilation takes about 6 minutes on Mac x64.

```bash
#!/usr/bin/env bash

# Make sure you have rustup installed
if ! rustup --version 2>&1 >/dev/null
then
    read "rustup could not be found. Do you want to install? (y/n)" DO_RUST_INSTALL
    if [ $DO_RUST_INSTALL = "y" ]; then
      echo "Installing rust"
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    else
      echo "Cannot continue without rust"
      exit 1
    fi
fi

# Setup rustup
rustup target add x86_64-apple-darwin

# Get current default interpreter
python_version=$($(brazil-path '[Python]run.runtimefarm')/bin/python --version | sed 's/Python //g' | cut -d. -f1,2)
pip_cmd=pip$python_version

# Check if we have pip installed.
if ! $pip_cmd 2>&1 >/dev/null
then
    echo "Pip must be installed to continue. Run \"python${python_version} -m pip install --upgrade pip\""
    exit 1
fi

# Set up necessary variables. This uses brazil-path to find the brazil package cache on your local machine, assuming
# it is in the dependency tree of the package you're wanting to build. It will then attempt to find the specific
# version number associated with pydantic. Note that it is using the dist-info folder and not the METADATA. We're
# assuming those are in sync
export ARCHFLAGS="-arch x86_64"
TEMP_DIR="/tmp/macos-pydantic-core-build"
mkdir ${TEMP_DIR}
DIR_ROOT=$(brazil-path run.lib | tr ":" "\n" | grep Python-pydantic-core)
echo "DIR_ROOT: ${DIR_ROOT}"
SITE_PACKAGE_DIR="${DIR_ROOT}/python${python_version}/site-packages/"
echo "SITE_PACKAGE_DIR: ${SITE_PACKAGE_DIR}"
DEST_DIR="${SITE_PACKAGE_DIR}pydantic_core/"
echo "DEST_DIR: ${DEST_DIR}"

PYDANTIC_PACKAGE_VERSION=$(ls ${SITE_PACKAGE_DIR} | grep 'dist-info' | awk -F'[-.]' '{print $2"."$3"."$4}' )
echo "PYDANTIC_PACKAGE_VERSION: ${PYDANTIC_PACKAGE_VERSION}"

# Compile it into temp directory
$pip_cmd install -v "pydantic_core==${PYDANTIC_PACKAGE_VERSION}" --compile --upgrade --no-binary :all: --no-cache-dir --target ${TEMP_DIR}
echo "Copying from ${TEMP_DIR}/pydantic_core/_pydantic_core.*.so to ${DEST_DIR}"
cp -v ${TEMP_DIR}/pydantic_core/_pydantic_core.*.so ${DEST_DIR}

# Optional: clean up the compilation directory
rm -rf ${TEMP_DIR}
```

If you see error like below, upgrade the required packages `pip3.10 install --upgrade "packaging>=24.2"`.

```
ImportError: Cannot import `packaging.licenses`.
        Setuptools>=77.0.0 requires "packaging>=24.2" to work properly.
        Please make sure you have a suitable version installed.
```

Once the compilation is completed, you can proceed with `brazil-build release`.

## Build and Test

We use the brazil runtime closure generated by `brazil-runtime-exec` or `brazil-bootstrap` as the environment.

You can run the MCP server:

```bash
brazil-runtime-exec atx-mainframe-dependency-manager-mcp
```

Or run from the runtime closure:

```bash
$(brazil-bootstrap)/bin/atx-mainframe-dependency-manager-mcp
```

You can run with MCP inspector as well:

```bash
npx @modelcontextprotocol/inspector brazil-runtime-exec atx-mainframe-dependency-manager-mcp
```

You can also directly test your server with your AI assistant:

```json
{
  "mcpServers": {
    "atx-mainframe-dependency-manager-mcp-runtime": {
      "disabled": false,
      "command": "<path-to-your-workspace>/env/ATX-MainframeDependencyManager-MCP-1.0/runtime/bin/atx-mainframe-dependency-manager-mcp",
      "args": [],
      "env": {},
      "transportType": "stdio"
    }
  }
}
```

## Vend to toolbox

### Prerequisite

- Follow [toolbox document](https://docs.hub.amazon.dev/builder-toolbox/user-guide/vending/) to create your own vending infrastructure.
- ⚠️ ([GP-6194](https://taskei.amazon.dev/tasks/GP-6194)) There will be a specialized MCP Registry CLI and Pipeline Target
  to publish to centralized MCP registry. It will replace toolbox as the vending solution for MCP soon.

### Bundling for each OS

You need to run bundling for each platform and architecture combination, and run the command with corresponding `--toolbox-os`.

```bash
brazil-build toolbox_bundler --toolbox-os alinux
```

`--toolbox-os` values are specified in [toolbox repository index](https://docs.hub.amazon.dev/builder-toolbox/user-guide/vending-repositories/#index-file)

- `alinux`: run from a brazil workspace with  `AL2*_x86_64` platform on AL2 or AL2023
- `alinux_aarch64`: run from a brazil workspace with `AL2*_aarch64` platform on AL2 or AL2023
- `osx`: run from a brazil workspace with `AL2*_aarch64` platform AND overlay platform support enabled on Mac Intel x64
- `osx_arm64`: run from a brazil workspace with `AL2*_aarch64` platform AND overlay platform support enabled on Mac M1/2 ARM64

This means, if you wish to publish your MCP server for multiple platforms and architectures to consume, your build must be running on the corresponding
machine and the brazil workspace must be configured with the right platform. For examples:

```bash
# On Amazon Linux 2
brazil workspace use --platform AL2_x86_64
brazil-build release
brazil-build toolbox_bundler --toolbox-os alinux

# On Mac x64
brazil workspace use --platform AL2_x86_64
brazil setup platform-support
brazil-build release  # If you see error related to pydantic_core, read next section
brazil-build toolbox_bundler --toolbox-os osx
```

#### How does it work

The command bundles `brazil-bootstrap` created runtime closure.

```bash
$ tree -L 1 $(brazil-bootstrap)
<path-to-your-workspace>/env/ATX-MainframeDependencyManager-MCP-1.0/runtime
├── ApolloCmd
├── bin
├── ...
├── lib
└── python3.10
```

The generated bundle is under `./build/private/tool-bundle`:

```text
./build/private/tool-bundle
└── <toolbox-os>
    ├── <version>.json
    └── <version>.tar.gz
```

### Publishing

⚠️ If your vending infrastructure account is in Conduit, update `setup.py` with the ADA command for conduit.

You should set environment variable `REPOSITORY_ACCOUNT`, `REPOSITORY_NAME`, and `REGISTRY_NAME`, based on your own toolbox infrastructure.

Run following command to publish the bundle to your own toolbox registry `head` channel:

```bash
brazil-build toolbox_bundler --toolbox-os alinux \
--publish --repository-account=$REPOSITORY_ACCOUNT --repository-name=$REPOSITORY_NAME --channel=head
```

Then you should test installing the tool from toolbox:

```bash
toolbox registry add s3://buildertoolbox-registry-${REGISTRY_NAME}-us-west-2/tools.json \
&& toolbox install atx-mainframe-dependency-manager-mcp --force --channel head
```

Configure your AI assistant to verify the installed command:

```json
{
  "mcpServers": {
    "atx-mainframe-dependency-manager-mcp-toolbox": {
      "disabled": false,
      "command": "atx-mainframe-dependency-manager-mcp",
      "args": [],
      "env": {},
      "transportType": "stdio"
    }
  }
}
```

Once you've tested the tool, you can publish to stable channel:

```bash
brazil-build toolbox_bundler --toolbox-os alinux \
--publish --repository-account=$REPOSITORY_ACCOUNT --repository-name=$REPOSITORY_NAME --channel=stable
```

Note that you should always update the package version in `setup.cfg` before publishing newer version. If you still have unpushed or uncommitted code locally, you won't be able to publish to stable channel.
